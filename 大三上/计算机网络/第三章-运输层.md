### 概述运输层服务
#### 运输层与网络层的关系
- 运输层协议为运行在不同主机上的应用进程提供了逻辑通信。运输层协议只工作在端系统
- 网络层提供了主机之间的通信

####  多路复用与多路分解
- 将运输层报文字段中的数据交付到正确的套接字的工作成为多路分解
- 从源主机的不同套接字中收集数据块，并为每个数据块封装首部信息从而生成报文段，然后将报文段传递到网络层的工作成为多路复用。
- 一个UDP套接字是由一个包含目的IP地址和目的端口号的二元组来全面表示的

#### 无连接运输：UDP
- UDP的优点
	+ 应用层能更好的控制要发送的数据和时间。采用UDP的时候，只要应用进程将数据传递给UDP，UDP就会将此数据打包生成UDP报文段并立即将其传递给网络层。
	+ 无需连接建立(DNS运行在UDP而不是TCP之上)
	+ 无连接状态：TCP在端系统中需要维护连接状态，次连接状态包括接受和发送缓存，拥塞控制参数，需要与确认号的参数。
	+ 分组首部开销小
- UDP校验和
	+ 发送方
		+ 发送方将分组中的内容当做一系列16比特字
		+ 将所有的比特字的和进行反码运算
		+ 将检验和放入UDP报文段
	+ 接收方
		+ 计算接收到的比特字和并与检验和相加
		+ 如果分组没有差错，接受方的和全部是1，如果有差错，将会出现0

#### 可靠数据传输协议
##### 构造可靠数据传输协议
- 完全可靠信道上的可靠数据传输协议：rdt1.0
	+ 有了完全可靠的信道，接收方就不需要提供任何反馈信息给发送方，因为不会发生任何差错
- 具有比特差错信道上的可靠数据传输协议：rdt2.0
	+ 处理差错比特有三种协议
		+ 差错检测：要求有额外的比特从发送方到接收方，这些比特将被汇集到rdt2.0数据分组检验和字段中
		+ 接收方反馈：接受方方向返回ACK和NCK分组
		+ 重传：接受方接收到有差错的分组时，发送方将重传该分组

	+ 如果发送方收到一个NAK分组，该协议重传最后一个分组并等待接受方返回想相应重传分组的ACK或者NAK
	+ 当发送方在等待ACK或者NAK的时候，它不能从上层获得更多的数据，仅当接收到ACK并且离开该状态时才能继续获取数据。因此发送方不会发送一块新的数据，直到发送方确信正确收到当前分组为止。因此rst2.0被称为停等协议。
- 具有比特差错信道上实现一个数据标序号的可靠数据传输协议：rdt2.1
	+ 数组分组中添加新的字段，让发送方对其数据分组编号。
	+ 发送方发送数据之后期待接收方返回的ACK或者NAK的值与当前数据分组的序号相同
- 具有比特差错信道上实现一个无NAK的可靠数据传输协议：rdt2.2
	+ 如果当前分组的序号是0，那么就应该接收到的ACK的值是0，如果接收到的ACK的值是1，说明出错了。
	+ 如果当前分组的序号是1，那么就应该接收到的ACK的值是1，如果接收到的ACK的值是0，说明出错了
	+ 通过上述两步，实现了无NAK的可靠数据传输协议
- 具有差错比特的丢包信道上的可靠数据传输：rdt3.0

#### 流水线可靠数据传输协议
- rdt可靠数据传输协议本身并无错，但因为他是停等协议，所以带宽利用率很低，为了解决这个问题，简单的方法是不采用停等协议。也就是允许发送方发送多个分组而无需等待确认。这种技术被称为流水线技术。
- 流水线技术对可靠数据传输协议带来下面的影响
	+ 必须增加序号范围，因为每个传输的分组(不包括重传的)必须有一个唯一的序号，而且也有多个在传输中的未确认分组。
	+ 协议的发送发和接收方也必须缓存多个分组。发送发最低限度应该能够缓冲那些已经发送但是没有确认的分组，接收方或许也需要缓存那些已经接受的分组。
	+ 所需序号范围和对缓冲的要求取决于数据传输协议处理丢失、损坏以及过度延时分组的方式。解决流水线的差错恢复有两种基本的方法：回退N步和选择重传。
		* 回退N步GBN-滑动窗口协议
			- 允许发送发发送多个分组而不需等待确认，但是也受限于在流水线中未确认的分组数不能超过最大允许数N
			- 基序号：最早的未确认的分组号
			- 下一个序号：最小的未使用的序号，也就是下一个待发送的分组
			- 发送发需要响应下面三种事件：上层的调用：先检测窗口是不是满了，如果满了，将数据返回给上册，隐式标明窗口已满，如果未满，打包发送数据；收到ACK；超时事件：定时器用于恢复丢失的数据和分组。如果出现超时，发送方将重传所有已发送但是还未确认的分组。
			- 接收方需要响应的事件很简单：如果一个序号为n的分组被正确接收到，则为分组n发送ACK，在其他所有情况下，接收方都将丢弃该分组，并且为最近按序接收的分组发送ACK
		* 选择重传SR
			- 选择重传协议通过让发送方仅重传那些它怀疑在接收方出错的分组而避免了不必要的重传。
			- SR接收方将确认一个正确接收的分组而不管其是否按序。失序的分组将被缓存直到所有的丢失分组都被收到。

#### TCP流控制（TCP flow control）
- TCP 为应用程序提供了流量控制服务，以消除发送方使接收方缓存溢出的可能性，即发送方的发送速率与接收方应用程序的读速率相匹配。
- 维护一个接收窗口的变量来提供流量控制。
